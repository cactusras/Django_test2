<form id="reservationForm" method="post" action='add/reservation/' >
    {% csrf_token %}
    <label for="doctor_id">医生ID：</label>
    <input type="number" id="doctor_id" name="doctor_id">

    <label for="date">选择日期：</label>
    <input type="date" id="date" name="date">

    <label for="expertise_name">专业名称：</label>
    <input type="text" id="expertise_name" name="expertise_name">

    <label for="time_start">选择时间：</label>
    <select id="time_start" name="time_start" disabled>
        <!-- 可用时间选项将由 JavaScript 动态添加 -->
    </select>

    <label for="expertise_list">医生的项目列表：</label>
    <ul id="expertise_list"></ul> <!-- 用于显示项目列表 -->

    <label for="working_hours">医生的上班时间：</label>
    <ul id="working_hours"></ul> <!-- 用于显示上班时间 -->

    <button type="submit">预约</button>
</form>
{% comment %} 

<div id="reservationFormContainer" style="display: none;">
    <h2>预约表单</h2>
    <form id="reservationForm" method="post" action='add/reservation/'>
        {% csrf_token %}

        <label for="doc_id">docID</label>
        <input type="number" id="doc_id" name="doc_id" required>

        <label for="reservation_date">预约日期：</label>
        <input type="date" id="reservation_date" name="reservation_date" required>


        <label for="time_start">选择时间：</label>
        <input type="time" id="time_start" name="time_start" required><br><br>

        <label for="expertise_name">专业名称：</label>
        <input type="text" id="expertise_name" name="expertise_name" required><br><br>

        <button type="submit">提交预约</button>
    </form>
</div>


 {% endcomment %}






<script>
    document.addEventListener('DOMContentLoaded', function () {
        const doctorIdInput = document.getElementById('doctor_id');
        const expertiseListContainer = document.getElementById('expertise_list');
        const workingHoursContainer = document.getElementById('working_hours');

        doctorIdInput.addEventListener('change', function() {
            const doctorId = doctorIdInput.value;
            if (doctorId) {
                fetch(`/doctor/expertise-list/${doctorId}/`)
                    .then(response => response.json())
                    .then(data => {
                        expertiseListContainer.innerHTML = '';
                        data.expertise_list.forEach(expertise => {
                            const li = document.createElement('li');
                            li.textContent = expertise.name;
                            expertiseListContainer.appendChild(li);
                        });
                    })
                    .catch(error => console.error('Error fetching doctor expertise list:', error));

                fetch(`/get_doc_working/${doctorId}/`)
                    .then(response => response.json())
                    .then(data => {
                        workingHoursContainer.innerHTML = '';
                        data.working_hours.forEach(workingHour => {
                            const li = document.createElement('li');
                            li.textContent = `${workingHour.start_date} - ${workingHour.end_date}: ${workingHour.start_time} - ${workingHour.end_time}`;
                            workingHoursContainer.appendChild(li);
                        });
                    })
                    .catch(error => console.error('Error fetching doctor working hours:', error));
            }
        });
    });

    function fetchAvailableTimes() {
        const doctorId = document.getElementById('doctor_id').value;
        const date = document.getElementById('date').value;
        const expertiseName = document.getElementById('expertise_name').value;

        if (doctorId && date && expertiseName) {
            fetch(`/available?doctor_id=${doctorId}&date=${date}&expertise_name=${expertiseName}`)
                .then(response => response.json())
                .then(data => {
                    const timeSelect = document.getElementById('time_start');
                    timeSelect.innerHTML = '';
                    data.reserve_choices.forEach(choice => {
                        const option = document.createElement('option');
                        option.text = choice;
                        option.value = choice;
                        timeSelect.add(option);
                    });
                    timeSelect.disabled = false;
                })
                .catch(error => console.error('Error fetching available times:', error));
        }
    }

    document.getElementById('date').addEventListener('input', fetchAvailableTimes);
    document.getElementById('doctor_id').addEventListener('input', fetchAvailableTimes);
    document.getElementById('expertise_name').addEventListener('input', fetchAvailableTimes);

{% comment %} 
    // 显示或隐藏预约表单
function toggleReservationForm() {
    const reservationFormContainer = document.getElementById('reservationFormContainer');
    reservationFormContainer.style.display = reservationFormContainer.style.display === 'none' ? 'block' : 'none';
}

// 点击预约按钮时显示预约表单
document.getElementById('testingform').addEventListener('submit', function (event) {
    event.preventDefault();  // 阻止默认表单提交行为
    toggleReservationForm();
});

// 表单提交时调用的函数
function submitReservationForm(event) {
    event.preventDefault();  // 阻止默认表单提交行为
    const form = document.getElementById('reservationForm');
    const formData = new FormData(form);

    fetch(form.action, {
        method: form.method,
        body: formData
    })
    .then(response => {
        if (response.ok) {
            alert('预约成功！');  // 可以替换为其他处理成功的操作
            form.reset();  // 清空表单
            toggleReservationForm();  // 隐藏预约表单
        } else {
            throw new Error('预约失败，请稍后再试。');
        }
    })
    .catch(error => {
        console.error('预约失败:', error);
        alert('预约失败，请稍后再试。');  // 可以替换为其他处理失败的操作
    });
}

// 监听预约表单的提交事件
document.getElementById('reservationForm').addEventListener('submit', submitReservationForm);
 {% endcomment %}

</script>