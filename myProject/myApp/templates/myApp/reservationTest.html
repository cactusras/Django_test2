<form id="reservationForm" method="post" action='add/reservation/' >
    {% csrf_token %}
    <label for="doctor_id">DoctorID：</label>
    <input type="number" id="doctor_id" name="doctor_id">

    <label for="date">reservation date：</label>
    <input type="date" id="date" name="date">

    <label for="expertise_name">treatments：</label>
    <input type="text" id="expertise_name" name="expertise_name">

    <label for="time_start">starting time：</label>
    <select id="time_start" name="time_start" disabled>
        <!-- 可用时间选项将由 JavaScript 动态添加 -->
    </select>

    <label for="expertise_list">医生的项目列表：</label>
    <ul id="expertise_list"></ul> <!-- 用于显示项目列表 -->

    <label for="working_hours">医生的上班时间：</label>
    <ul id="working_hours"></ul> <!-- 用于显示上班时间 -->

    <button type="submit">预约</button>
</form>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const doctorIdInput = document.getElementById('doctor_id');
        const expertiseListContainer = document.getElementById('expertise_list');
        const workingHoursContainer = document.getElementById('working_hours');

        doctorIdInput.addEventListener('change', function() {
            const doctorId = doctorIdInput.value;
            if (doctorId) {
                fetch(`/doctor/expertise-list/${doctorId}/`)
                    .then(response => response.json())
                    .then(data => {
                        expertiseListContainer.innerHTML = '';
                        data.expertise_list.forEach(expertise => {
                            const li = document.createElement('li');
                            li.textContent = expertise.name;
                            expertiseListContainer.appendChild(li);
                        });
                    })
                    .catch(error => console.error('Error fetching doctor expertise list:', error));

                fetch(`/get_doc_working/${doctorId}/`)
                    .then(response => response.json())
                    .then(data => {
                        workingHoursContainer.innerHTML = '';
                        data.working_hours.forEach(workingHour => {
                            const li = document.createElement('li');
                            li.textContent = `${workingHour.start_date} - ${workingHour.end_date}: ${workingHour.start_time} - ${workingHour.end_time}`;
                            workingHoursContainer.appendChild(li);
                        });
                    })
                    .catch(error => console.error('Error fetching doctor working hours:', error));
            }
        });
    });

    function fetchAvailableTimes() {
        const doctorId = document.getElementById('doctor_id').value;
        const date = document.getElementById('date').value;
        const expertiseName = document.getElementById('expertise_name').value;

        if (doctorId && date && expertiseName) {
            fetch(`/available?doctor_id=${doctorId}&date=${date}&expertise_name=${expertiseName}`)
                .then(response => response.json())
                .then(data => {
                    const timeSelect = document.getElementById('time_start');
                    timeSelect.innerHTML = '';
                    data.reserve_choices.forEach(choice => {
                        const option = document.createElement('option');
                        option.text = choice;
                        option.value = choice;
                        timeSelect.add(option);
                    });
                    timeSelect.disabled = false;
                })
                .catch(error => console.error('Error fetching available times:', error));
        }
    }

    document.getElementById('date').addEventListener('input', fetchAvailableTimes);
    document.getElementById('doctor_id').addEventListener('input', fetchAvailableTimes);
    document.getElementById('expertise_name').addEventListener('input', fetchAvailableTimes);


</script>