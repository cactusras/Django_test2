{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>牙醫登入頁面</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="{% static 'myApp/assets/favicon.ico' %}" />
        <!-- Bootstrap icons-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="{% static 'myApp/css/styles.css' %}" rel="stylesheet" />

        <style>
            body, html {
              height: 100%;
              margin: 0;
              padding: 0;
            }
            .page-container {
              min-height: 100%;
              background-color: #FFFFF4;
            }
            .content {
              padding: 20px;
            }
          </style>
          <script>
            const csrfToken = "{{ csrf_token}}";
          </script>
    </head>

    <body>
        <!--網頁頭-->
        <nav class="navbar navbar-expand-lg" style="background-color:#F0EAD6; height: 100px;">
          <div class="container px-4 px-lg-5">
              <img src="{% static 'myApp/assets/dental.png' %}" alt="DEN Logo">
              <a class="navbar-brand" href="#!" style="font-size: 24px;">牙醫預約平台</a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
              <div class="collapse navbar-collapse" id="navbarSupportedContent">
                  <div class="ms-auto">
                      <button class="btn btn-outline-dark" type="submit" style="font-size: 20px;" id="nav_btn" onclick="navBtn_listener(event)">
                          <i class="bi bi-person-fill"></i>
                          牙醫
                      </button>
                  </div>
              </div>
          </div>
      </nav>
      <section class="py-5"  style="background-color:#FFFFF4">
        <div class="container">
          <div class="row g-2">
            <div class="col-md-6">
              <div class="p-3" style="height:600px;">
                <div class="col d-flex align-items-center justify-content-center" style="background-color:#F0EAD6; border: 1px solid #ada089; height:80px; font-size: 20px;">
                    當日預約確認報到
                </div>

                <div class="col d-flex justify-content-center" style="background-color:#FFFFF0; border: 1px solid #ada089; height:500px; font-size: 20px; overflow: auto;">
                  <table class="table table-hover" style="border: 1px solid #ada089;" id = "schedule_table">
                    <thead>
                        <tr>
                            <th scope="col"><i class="bi bi-clock-fill"></i></th>
                            <th scope="col">週一</th>
                            <th scope="col">週二</th>
                            <th scope="col">週三</th>
                            <th scope="col">週四</th>
                            <th scope="col">週五</th>
                            <th scope="col">週六</th>
                            <th scope="col">週日</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th scope="col"><p>10:00<br>-<br>11:00<br></p></th>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                        </tr>
                        <tr>
                            <th scope="col"><p>11:00<br>-<br>12:00<br></p></th>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                        </tr>
                        <tr>
                            <th scope="col"><p>12:00<br>-<br>13:00<br></p></th>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                        </tr>
                        <tr>
                            <th scope="col"><p>13:00<br>-<br>14:00<br></p></th>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                        </tr>
                        <tr>
                            <th scope="col"><p>15:00<br>-<br>16:00<br></p></th>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                        </tr>
                        <tr>
                            <th scope="col"><p>16:00<br>-<br>17:00<br></p></th>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                        </tr>
                        <tr>
                            <th scope="col"><p>17:00<br>-<br>18:00<br></p></th>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                        </tr>
                        <tr>
                            <th scope="col"><p>19:00<br>-<br>20:00<br></p></th>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                        </tr>
                        <tr>
                            <th scope="col"><p>20:00<br>-<br>21:00<br></p></th>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                        </tr>
                    </tbody>
                  </table>
                </div>
              </div>  
            </div>
            <div class="col-md-6">
                    <div class="p-3" style="height:600px;">
                        <div class="col d-flex align-items-center justify-content-center" style="background-color:#F0EAD6; border: 1px solid #ada089; height:80px; font-size: 20px;">
                            各時段詳細資訊
                        </div>
                          <!-- 各時段詳細資訊 -->
                        <div class="col d-flex justify-content-center" style="background-color:#FFFFF0; border: 1px solid #ada089; height:500px; font-size: 20px; overflow: auto;">
                          <table class="table table-hover" id = "doctor_reserve_body">
                            <thead>
                              <tr>
                                <!-- <th scope="col"><i class="bi bi-clock-fill"></i></th> -->
                                <th scope="col">星期</th>
                                <th scope="col">時間</th>
                                <th scope="col">患者</th>
                                <th scope="col">項目</th>
                                <th scope="col">狀態</th>
                              </tr>
                            </thead>
                            <tbody>
                            </tbody>
                          </table>    
                        </div>
                    </div>
            </div>
        </div>
      </section>

        <!--頁面底-->
      <footer class="py-5 bg-dark">
          <div class="container"><p class="m-0 text-center text-white">Copyright &copy; Your Website 2023</p></div>
      </footer>
      <!-- Bootstrap core JS-->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
      <!-- Core theme JS-->
      <script src="{% static 'myApp/js/scripts.js' %}"></script>
      <script>

        document.addEventListener("DOMContentLoaded", function() {
            clin_reserve_info();
        });
        function getRowIndex(startTime, endTime) {
            console.log("startTime_for_mapping: ", startTime);
            const timeMapping = {
                'startTimeMap' :{
                    '10:00': 0,
                    '11:00': 1,
                    '12:00': 2,
                    '13:00': 3,
                    '15:00': 4,
                    '16:00': 5,
                    '17:00': 6,
                    '19:00': 7,
                    '20:00': 8
                },
                'endTimeMap' :{
                    '11:00': 0,
                    '12:00': 1,
                    '13:00': 2,
                    '14:00': 3,
                    '16:00': 4,
                    '17:00': 5,
                    '18:00': 6,
                    '20:00': 7,
                    '21:00': 8
                }
                
            };
            return [timeMapping.startTimeMap[startTime], timeMapping.endTimeMap[endTime]];
        }

        function clin_reserve_info() {
          event.preventDefault();
            fetch('/doctor/page/loading/')
            .then(response => response.json())
            .then(data => {
              const reservations = data.reservation_list;
              const schedule_list = data.schedule_list;
              const table = document.getElementById('schedule_table');
              schedule_list.forEach(schedule => {
                const rowIndexes = getRowIndex(schedule['work_start_time'],schedule['work_end_time']);
                const colIndex = schedule['work_day'];
                for (let i = rowIndexes[0]; i <= rowIndexes[1]; i++) {
                    const row = table.rows[i+1];
                    if (row) {
                        const cell = row.cells[colIndex];
                        if (cell) {
                            const initialWidth = cell.offsetWidth;
                            cell.style.backgroundColor = '#6D6460';
                            cell.style.width = `${initialWidth}px`;
                        }
                    }
                }
              });

              reservations.forEach(reservation => {
                const rowIndexes = getRowIndex(reservation['starting'],reservation['starting']);
                const colIndex = reservation['day_of_week'];
                for (let i = rowIndexes[0]; i <= rowIndexes[1]; i++) {
                    const row = table.rows[i+1];
                    if (row) {
                        const cell = row.cells[colIndex];
                        if (cell) {
                            const initialWidth = cell.offsetWidth;
                            cell.style.backgroundColor = '#FFBD33';
                            cell.style.width = `${initialWidth}px`;
                        }
                    }
                }
              });

              const tableBody = document.getElementById('doctor_reserve_body');
              reservations.forEach(reservation => {
                  const row = document.createElement('tr');
                  row.innerHTML = `
                      <td>${reservation.day_of_week}</td>
                      <td>${reservation.appointment_date}</td>
                      <td>${reservation.client_name}</td>
                      <td>${reservation.expertise}</td>
                      <td>
                          <button class="cancel-btn" data-id="${reservation.id}">${reservation.status}</button>
                      </td>
                  `;
                  tableBody.appendChild(row);
                  console.log("success")
              });
              const buttons = document.querySelectorAll('.cancel-btn');
                buttons.forEach(button => {
                    button.addEventListener('click', function() {
                        const reservationId = this.getAttribute('data-id');
                        if (confirm('Are you sure you want to cancel this reservation?')) {
                            cancelReservation(reservationId);
                        }
                    });
              });
            })
            .catch(error => {
                // 处理错误情况，例如显示错误消息给用户
                alert('Error loading clinic reservations: ' + error.message);
            });
        }
        function cancelReservation(reservationId) {
          fetch(`/doctor/page/cancel_reservation/${reservationId}/`, {
              method: 'POST',
              headers: {
                  'X-CSRFToken': csrfToken,  // Include CSRF token
              }
          })
          .then(response => response.json())
          .then(data => {
              if (data.status === 'success') {
                  alert('Reservation cancelled successfully.');
                  window.location.href = '/doctor/page/';  // Reload the page to update the reservation list
              } else {
                  alert('Error cancelling reservation: ' + data.message);
              }
          })
          .catch(error => {
              alert('Error cancelling reservation: ' + error.message);
          });
        }
      </script>
    </body>
</html>
